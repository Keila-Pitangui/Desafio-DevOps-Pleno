# /etc/nginx/nginx.conf

user nginx;
worker_processes auto;
pcre_jit on;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # DEFINIÇÃO DE SEGURANÇA (Rate Limiting)
    # Aumentado para 50r/s para suportar assets do Grafana/Prometheus
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=50r/s;

    # CONFIGURAÇÕES GLOBAIS DE PERFORMANCE
    server_tokens off; 
    client_max_body_size 10m; # Aumentado para suportar uploads de logs se necessário
    sendfile on;
    tcp_nopush on;

    # SSL OPTIMIZATION
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m; # Aumentado para melhor performance
    ssl_session_timeout 1d;

    # COMPRESSÃO GZIP (Otimizada para APIs e Dashboards)
    gzip on;
    gzip_comp_level 5; # Equilíbrio entre CPU e compressão
    gzip_min_length 256;
    gzip_types 
        text/plain 
        text/css 
        application/json 
        application/javascript 
        application/xml 
        image/svg+xml;

    # LOGS
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    server {
    listen 80 default_server;
    listen [::]:80 default_server;

    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;

    ssl_certificate /etc/nginx/certs/api.jimi.local.crt;
    ssl_certificate_key /etc/nginx/certs/api.jimi.local.key;

    server_name _; # Captura qualquer domínio não mapeado

    # redirecionamento para a página 404
    error_page 404 /404.html;

    location / {
        return 404;
    }

    # Protege o arquivo para ser acessado apenas internamente pelo Nginx
    location /404.html {
        internal; 
    }
}

    server {
        listen 80;
        listen 443 ssl;
        server_name api.jimi.local;

        # CERTIFICADOS
        ssl_certificate /etc/nginx/certs/api.jimi.local.crt;
        ssl_certificate_key /etc/nginx/certs/api.jimi.local.key;

        # APLICAÇÃO DO RATE LIMIT (Burst alto para evitar 503 no carregamento)
        limit_req zone=api_limit burst=100 nodelay;

        # CABEÇALHOS DE PROXY GLOBAIS (Melhor prática)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;


        # 2. HEALTH CHECK
        location /health {
            proxy_pass http://api:9080/v1/heartbeat/; 
            access_log off;
        }

        # 3. GRAFANA
        location /grafana/ {
            proxy_pass http://grafana:3000;
            proxy_redirect off;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /grafana;
        }

        # 4. PROMETHEUS
        location /prometheus/ {
            proxy_pass http://prometheus:9090/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

       # loki
        location /loki/ {
            proxy_pass http://loki:3100/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /v1/telemetry {
            proxy_pass http://webhook:7000/v1/telemetry;
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        }
        # Endpoint de Alarmes
        location /v1/alarms {
            proxy_pass http://webhook:7000/v1/alarms;
        }

        # Endpoint de Heartbeat
        location /v1/heartbeat {
            proxy_pass http://webhook:7000/v1/heartbeat;
        }

        location /metrics {
            proxy_pass http://webhook:7000/metrics;
        }

                location / {
            proxy_pass http://api:9080/;
        }

    }
}
